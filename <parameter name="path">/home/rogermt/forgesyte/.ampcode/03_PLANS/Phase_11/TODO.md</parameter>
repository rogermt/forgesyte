<parameter name="content"># Phase 11 Implementation - Complete Plan

## Commit 6 - Error Tracking & Metrics
**Status: ✅ COMPLETE**

### Tasks:
- [x] 1. Add `execution_time_ms` field to `PluginSandboxResult`
- [x] 2. Add `execution_time_ms` field to `PluginHealthResponse` model
- [x] 3. Track execution time in `run_plugin_sandboxed()`
- [x] 4. Update `PluginMetadata` to store execution times
- [x] 5. Add `avg_execution_time_ms` to health response (calculated from last 10 runs)
- [x] 6. Update `plugin_registry.py` to track execution metrics
- [x] 7. Write tests for execution time tracking (24 tests pass)

### Files Modified:
- `server/app/plugins/sandbox/sandbox_runner.py`
- `server/app/plugins/health/health_model.py`
- `server/app/plugins/loader/plugin_registry.py`
- `server/app/services/plugin_management_service.py`
- `server/tests/plugins/test_tool_runner_sandbox.py`

---

## Commit 7 - Timeout/Memory Guards
**Status: ✅ COMPLETE**

### Tasks:
- [x] 1. Implement `timeout.py`:
  - [x] `TimeoutGuardResult` dataclass with timeout tracking
  - [x] `run_with_timeout()` function with ThreadPoolExecutor
  - [x] `run_sandboxed_with_timeout()` convenience function
  - [x] Default timeout: 60 seconds

- [x] 2. Implement `memory_guard.py`:
  - [x] `MemoryGuardResult` dataclass with memory tracking
  - [x] `get_memory_usage_bytes()` using psutil
  - [x] `run_with_memory_guard()` function
  - [x] Default limit: 1 GB (1024 MB)

- [x] 3. Integrate guards into sandbox runner:
  - [x] `run_with_timeout()` function in sandbox_runner.py
  - [x] `run_sandboxed_with_timeout()` convenience function

- [x] 4. Update `sandbox/__init__.py` exports

- [x] 5. Write tests for timeout and memory guards (24 tests pass)

### Files Modified:
- `server/app/plugins/sandbox/timeout.py`
- `server/app/plugins/sandbox/memory_guard.py`
- `server/app/plugins/sandbox/sandbox_runner.py`
- `server/app/plugins/sandbox/__init__.py`

---

## Commit 8 - Enforce Governance
**Status: ✅ COMPLETE**

### Tasks:
- [x] 1. Run all server tests
  ```bash
  cd server && uv run pytest tests/plugins/ -v
  ```
  **Result:** 24/24 passed ✅

- [x] 2. Run linting
  ```bash
  cd server && uv run ruff check app/
  ```
  **Result:** All checks passed ✅

- [x] 3. Run type checking
  ```bash
  cd server && uv run mypy app/plugins/sandbox/ --no-site-packages
  ```
  **Result:** Success: no issues found in 4 source files ✅

- [x] 4. Update this TODO.md with verification results

- [x] 5. Update PHASE_11_PROGRESS.md to mark all commits complete

### Files Modified:
- `.ampcode/03_PLANS/Phase_11/TODO.md`
- `.ampcode/03_PLANS/Phase_11/PHASE_11_PROGRESS.md`

---

## Verification Checklist (All Commits)

### Pre-Verification:
- [x] All tests pass locally (24/24)
- [x] No linting errors
- [x] No type errors
- [x] Pre-commit hooks pass

### Post-Verification:
- [x] Sandbox runner catches all exception types
- [x] Registry tracks success/error counts
- [x] Execution time is tracked
- [x] Timeout guard works (60s default)
- [x] Memory guard works (1GB default)
- [x] Health API returns complete responses

---

## Notes

### Error Types to Handle:
- ImportError (missing dependencies)
- RuntimeError (plugin runtime errors)
- ValueError (invalid arguments)
- MemoryError (memory exhausted)
- TimeoutError (execution timeout)
- Generic Exception (catch-all)

### Metrics to Track:
- success_count: Number of successful executions
- error_count: Number of failed executions
- uptime_seconds: Seconds since plugin was loaded
- last_used: Timestamp of last execution
- execution_time_ms: Last execution time in milliseconds
- avg_execution_time_ms: Average execution time (last 10 runs)

### Default Limits:
- Timeout: 60 seconds
- Memory: 1024 MB (1 GB)
</parameter>
