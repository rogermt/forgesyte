# Phase 15 Implementation Plans

## Overview
Phase 15 extends Phase 14's single-frame DAG execution to support **offline MP4 processing** using **YOLO + OCR** pipeline only.

## Scope
- **IN**: MP4 upload, frame extraction, YOLO→OCR DAG per frame, aggregated results
- **OUT**: Job queue, persistence, tracking, ReID, Viz, streaming, async workers

## MANDATORY Pre-Commit Verification (ALL MUST BE GREEN BEFORE ANY COMMIT)
### Test Suite Requirements
1. **Server Tests**: ALL server tests must pass (`uv run pytest tests/`)
2. **Web-UI Tests**: ALL web-ui tests must pass (`npm run test -- --run`)
3. **Execution-CI**: Execution governance must pass (`python scripts/scan_execution_violations.py`)
4. **Governance-CI**: Phase 14 governance must pass (`python tools/validate_plugins.py && python tools/validate_pipelines.py`)

### Failure Policy
- **CRITICAL: NO COMMITS until ALL 4 test suites are GREEN, ANY test failure requires immediate fix**
- **NO COMMITS** until ALL 4 test suites are GREEN
- **ANY test failure** = Immediate fix required, no commits until fixed
- **Failure to run the tests** = Immediate termination

## Implementation Tasks (10 Commits - TDD Approach)

### COMMIT 1: Pipeline Definition
**User Story**: Pipeline Definition
- Create `server/app/pipelines/yolo_ocr.json`
  - Define YOLO → OCR DAG
  - Node: detect (plugin: yolo, tool: detect_objects)
  - Node: read (plugin: ocr, tool: extract_text)
  - Edge: detect → read
  - Entry nodes: ["detect"]
  - Output nodes: ["read"]
- Validate with `validate_pipelines.py`
- **Pre-commit**: Run ALL 4 test suites - must be GREEN

### COMMIT 2: Payload Contract & Scope Boundaries
**User Story**: Payload Contract & Scope Boundaries
- Define payload contract: `{frame_index, image_bytes}`
- Document scope boundaries (forbidden items)
- Response schema: `{results: [{frame_index, result}]}`
- **Pre-commit**: Run ALL 4 test suites - must be GREEN

### COMMIT 3: OpenCV Dependency + Test Fixtures + Corrupt Harness
**User Story**: OpenCV Dependency + Test Fixtures + Corrupt Harness
- Add opencv-python to dependencies
- Create `server/app/tests/fixtures/generate_tiny_mp4.py`
  - Generate 3-frame MP4 (320×240)
  - Solid-color frames with frame index text
- Generate `server/app/tests/fixtures/tiny.mp4`
- Create corrupt MP4 generator for error testing
- **Pre-commit**: Run ALL 4 test suites - must be GREEN

### COMMIT 4: VideoFilePipelineService + Mock DAG + Pure Unit Tests
**User Story**: VideoFilePipelineService + Mock DAG + Pure Unit Tests
- Create `server/app/services/video_file_pipeline_service.py`
  - VideoFilePipelineService class
  - Frame extraction using OpenCV
  - Per-frame DAG execution via DagPipelineService
  - Results aggregation
  - Support frame_stride and max_frames options
- Create mock DAG service for unit testing
- Create pure unit tests (no plugins)
- **Pre-commit**: Run ALL 4 test suites - must be GREEN

### COMMIT 5: Router + App Wiring + Registration Test
**User Story**: Router + App Wiring + Registration Test
- Create `server/app/api/routes/video_file.py`
  - POST /video/upload-and-run endpoint
  - Multipart file upload handling
  - Content-type validation (MP4/QuickTime)
  - Temp file management
  - Error handling
- Update `server/app/main.py` to include video_file.router
- Create registration test
- **Pre-commit**: Run ALL 4 test suites - must be GREEN

### COMMIT 6: Integration Tests + Full Error Coverage
**User Story**: Integration Tests + Full Error Coverage
- Create `server/app/tests/video/test_video_upload_and_run.py`
  - Integration test for MP4 upload and run
  - Validate response format
  - Validate per-frame results
- Create `server/app/tests/video/test_invalid_pipeline.py`
  - Test invalid pipeline_id handling (404)
- Create `server/app/tests/video/test_invalid_file_type.py`
  - Test invalid file type handling (400)
  - Test missing fields (422)
  - Test empty/corrupted MP4 (400)
- **Pre-commit**: Run ALL 4 test suites - must be GREEN

### COMMIT 7: Schema Regression Guard + Golden Snapshot
**User Story**: Schema Regression Guard + Golden Snapshot
- Create schema regression test
  - Assert top-level keys only: ["results"]
  - Assert item keys: ["frame_index", "result"]
- Create golden snapshot test
  - Commit golden_output.json
  - Test deterministic behavior with tiny.mp4
- **Pre-commit**: Run ALL 4 test suites - must be GREEN

### COMMIT 8: Stress + Fuzz Test Suites
**User Story**: Stress + Fuzz Test Suites
- Create stress test (1000-frame test)
  - Verify frame indices are sequential
- Create fuzz test
  - Header-only MP4
  - Truncated MP4
  - Random-byte MP4
  - Ensure safe error handling
- **Pre-commit**: Run ALL 4 test suites - must be GREEN

### COMMIT 9: Governance Tooling + CI + Smoke Test
**User Story**: Governance Tooling + CI + Smoke Test
- Update forbidden_vocabulary.yaml with Phase 15 rules
- Create governance validator script
- Create smoke test script: `scripts/smoke_test_video_batch.sh`
  - Plugin validation
  - Pipeline validation
  - Governance validator
  - Pytest (video tests only)
- **Pre-commit**: Run ALL 4 test suites - must be GREEN

### COMMIT 10: Documentation + Demo Script + Rollback Plan
**User Story**: Documentation + Demo Script + Rollback Plan
- Update Phase 15 Overview to batch-only scope
- Create demo script for local testing
- Document rollback plan
- Final smoke test verification
- **Pre-commit**: Run ALL 4 test suites - must be GREEN

## Post-Implementation Verification
- [ ] Re-run ALL 4 test suites - must be GREEN
- [ ] Run video integration tests - must pass
- [ ] Run Phase 15 smoke test - must pass

## Success Criteria
✅ ALL 4 test suites GREEN before any commit
✅ `POST /video/upload-and-run` works
✅ YOLO→OCR pipeline validates and executes
✅ Per-frame DAG execution works
✅ Results aggregated correctly
✅ ZERO test failures

## Timeline
15-20 hours (10 commits)

## References
- `PHASE_15_SCOPE.md` - Scope boundaries
- `PHASE_15_DEFINITION_OF_DONE.md` - Definition of done
- `PHASE_15_FIRST_FAILING_TEST.md` - First failing test
- `PHASE_15_FORBIDDEN_VOCAB.md` - Forbidden vocabulary and governance rules
- `PHASE_15_NOTES_01.md` - Tiny MP4 generator, payload contract, README, governance
- `PHASE_15_NOTES_02.md` - Integration tests, architecture, PR template
- `PHASE_15_NOTEs_03.md` - Migration guide, release notes, onboarding
- `PHASE_15_NOTES_04.md` - Architecture diagram, demo script, project board
- `PHASE_15_OCR_&_YOLO_JSON.md` - Valid YOLO+OCR pipeline examples
- `PHASE_15_OVERVIEW.md` - High-level overview
- `PHASE_15_SPEC.md` - MP4 upload spec

## Governance Rules (Non-Negotiable)
1. **No phase-named files in functional directories** - Use `video/`, not `phase15/`
2. **No job queue** - Synchronous processing only
3. **No async workers** - Blocking execution
4. **No persistence** - No database writes
5. **No tracking/ReID** - Stateless per frame
6. **No streaming** - Batch processing only
7. **No state across frames** - Each frame independent
8. **Payload must have**: frame_index + image_bytes (raw JPEG, not base64)
9. **Response schema**: {results: [{frame_index, result}]} - frozen, no extra fields

## User Story Index Mapping
| Commit | User Story |
|--------|-------------|
| 1 | Pipeline Definition |
| 2 | Payload Contract & Scope Boundaries |
| 3 | OpenCV Dependency + Test Fixtures + Corrupt Harness |
| 4 | VideoFilePipelineService + Mock DAG + Pure Unit Tests |
| 5 | Router + App Wiring + Registration Test |
| 6 | Integration Tests + Full Error Coverage |
| 7 | Schema Regression Guard + Golden Snapshot |
| 8 | Stress + Fuzz Test Suites |
| 9 | Governance Tooling + CI + Smoke Test |
| 10 | Documentation + Demo Script + Rollback Plan |
